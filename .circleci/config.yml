# Use the latest 2.1 version of CircleCI pipeline process engine.
version: 2.1

jobs:
  docs-build:
    docker:
      - image: cimg/node:17.7.2-browsers
    steps:
      - checkout
      - restore_cache:
          key: v2-deps-{{ checksum "package-lock.json" }}
      - run:
          name: Install and configure
          command: npm install
      - save_cache:
          key: v2-deps-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - run:
          name: Check spelling
          command: npm run-script spellcheck
      - run:
          name: Generate website
          command: npm run-script build
      - run:
          name: Generate PDF
          command: npm run-script pdf-build
      - run:
          name: list files generated
          command: ls -al _site
      - persist_to_workspace: #save the _site folder for the next job to run(./_site), the folder generated by eleventy with all the html in it
          root: .
          paths: _site
  docs-deploy:
    docker:
      - image: cimg/node:17.7.2
    steps:
      - checkout
      - attach_workspace: #get the saved folder(./_site) in this job so we can use it
          at: .
      - run:
          name: Disable jekyll builds
          command: touch _site/.nojekyll
      - run:
          name: Install and configure dependencies
          command: |
            git config user.email "sambuccid@gmail.com"
            git config user.name "sambuccid"
      - add_ssh_keys: #try to upload to github using this key
          fingerprints:
            - "93:fe:cf:1c:ff:65:88:35:0e:4b:d4:9c:4e:5a:9c:43"
      - run:
          #deploy all the files inside the _site folder
          name: Deploy docs to the gh-pages branch
          command: npx gh-pages@3.0.0 --dotfiles --message "[skip ci] Generate Website" --dist _site

workflows:
  create-website:
    jobs:
      - docs-build:
          filters:
            branches:
              ignore: gh-pages
      - docs-deploy:
          requires:
            - docs-build
          filters:
            branches:
              only: main
