# Use the latest 2.1 version of CircleCI pipeline process engine.
version: 2.1

jobs:
  docs-build:
    docker:
      - image: node:17.2.0
    steps:
      - checkout
      - run:
          name: Install and configure
          command: npm install @11ty/eleventy
      - run:
          name: Generate website
          command: npx @11ty/eleventy
      - persist_to_workspace: #save the _site folder for the next job to run(./_site), the folder generated by eleventy with all the html in it
          root: .
          paths: _site
  docs-deploy:
    docker:
      - image: node:17.2.0
    steps:
      - checkout
      - attach_workspace: #get the saved folder(./_site) in this job so we can use it
          at: .
      - run:
          name: Disable jekyll builds
          command: touch _site/.nojekyll
      - run:
          name: Install and configure dependencies
          command: |
            npm install -g --silent gh-pages
            git config user.email "sambuccid@gmail.com"
            git config user.name "sambuccid"
      - add_ssh_keys: #try to upload to github using this key
          fingerprints:
            - "4a:79:bd:a2:95:73:8b:58:4a:e0:ad:2d:04:1b:e2:24"
      - run:
          name: Deploy docs to the gh-pages branch
          command: gh-pages --dotfiles --message "[skip ci] Generate Website" --dist _site #deploy all the files inside the _site folder
            
workflows:
  say-hello-workflow:
    jobs:
      - docs-build:
          filters:
            branches:
              only: main
      - docs-deploy:
          requires:
            - docs-build
          filters:
            branches:
              only: main